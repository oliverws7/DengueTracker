<!DOCTYPE html>
<html>
<head>
    <title>🔔 Teste WebSocket - Dengue Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .notification { padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; background: #e7f3ff; border-radius: 5px; }
        .event-log { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa; }
        .event { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .controls { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 Teste WebSocket - Dengue Tracker</h1>
        
        <div id="status" class="status disconnected">
            ❌ Desconectado
        </div>

        <div class="controls">
            <h3>🎮 Controles de Teste</h3>
            <button class="btn-primary" onclick="simularUsuarioEntrando()">👤 Simular Usuário Entrando</button>
            <button class="btn-success" onclick="simularNovoReporte()">🎯 Simular Novo Reporte</button>
            <button class="btn-warning" onclick="simularConquista()">🏆 Simular Conquista</button>
            <button class="btn-primary" onclick="entrarSalaRanking()">📊 Entrar Sala Ranking</button>
            <button class="btn-warning" onclick="entrarSalaAdmin()">🛡️ Entrar Sala Admin</button>
        </div>

        <div class="controls">
            <h3>🗺️ Ouvir Área Específica</h3>
            <input type="number" id="lat" placeholder="Latitude" value="-23.55" step="0.01">
            <input type="number" id="lng" placeholder="Longitude" value="-46.63" step="0.01">
            <button onclick="ouvirArea()">👂 Ouvir Área</button>
        </div>

        <h3>📝 Log de Eventos:</h3>
        <div id="event-log" class="event-log"></div>

        <h3>🔔 Notificações:</h3>
        <div id="notifications"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:5000');
        let usuarioId = 'user-' + Math.random().toString(36).substr(2, 9);
        
        // Conexão
        socket.on('connect', () => {
            updateStatus('✅ Conectado ao servidor WebSocket', 'connected');
            addEvent('🔌 Conectado ao servidor');
            
            // Simular usuário entrando
            simularUsuarioEntrando();
        });

        socket.on('disconnect', (reason) => {
            updateStatus('❌ Desconectado: ' + reason, 'disconnected');
            addEvent('❌ Desconectado: ' + reason);
        });

        socket.on('error', (error) => {
            addEvent('💥 Erro: ' + error);
        });

        // Eventos de negócio
        socket.on('novo-reporte', (data) => {
            addNotification(`🔔 ${data.mensagem}`, `Local: ${data.reporte.endereco} | Usuário: ${data.reporte.usuario}`, 'info');
            addEvent(`📋 Novo reporte: ${data.reporte.endereco} por ${data.reporte.usuario}`);
        });

        socket.on('alerta-admin', (data) => {
            addNotification(`🛡️ ${data.mensagem}`, `Prioridade: ${data.prioridade}`, 'warning');
            addEvent(`🛡️ Alerta admin: ${data.mensagem}`);
        });

        socket.on('pontos-atualizados', (data) => {
            addNotification(`🎮 ${data.usuario} ganhou pontos!`, `Novos pontos: ${data.pontosNovos} (+${data.diferenca})`, 'success');
            addEvent(`📈 Pontos atualizados: ${data.usuario} → ${data.pontosNovos} pontos`);
        });

        socket.on('ranking-atualizado', (data) => {
            addNotification(`🏆 Ranking atualizado!`, `${data.usuario} - ${data.pontos} pontos`, 'info');
            addEvent(`📊 Ranking: ${data.usuario} com ${data.pontos} pontos`);
        });

        socket.on('conquista-desbloqueada', (data) => {
            addNotification(`🎉 ${data.mensagem}`, `${data.conquistas.length} conquista(s) desbloqueada(s)!`, 'success');
            addEvent(`🏆 Conquista: ${data.mensagem}`);
        });

        socket.on('foco-eliminado', (data) => {
            addNotification(`✅ ${data.mensagem}`, `+${data.pontosGanhos} pontos ganhos!`, 'success');
            addEvent(`✅ Foco eliminado: ${data.endereco}`);
        });

        socket.on('reporte-na-area', (data) => {
            addNotification(`⚠️ ${data.mensagem}`, `Endereço: ${data.endereco}`, 'warning');
            addEvent(`🗺️ Reporte na área: ${data.endereco}`);
        });

        socket.on('usuarios-online-atualizados', (data) => {
            addEvent(`👥 Usuários online: ${data.totalOnline} - ${data.usuarios.map(u => u.nome).join(', ')}`);
        });

        socket.on('estatisticas-atualizadas', (data) => {
            addEvent(`📊 Estatísticas: ${data.totalUsuarios} usuários, ${data.totalPontos} pontos totais`);
        });

        socket.on('recompensa-diaria', (data) => {
            addNotification(`📅 ${data.mensagem}`, `Streak: ${data.streak} dias | +${data.pontos} pontos`, 'success');
            addEvent(`🎁 Recompensa diária: +${data.pontos} pontos`);
        });

        // Funções de simulação
        function simularUsuarioEntrando() {
            const dadosUsuario = {
                usuarioId: usuarioId,
                nome: 'Usuário Teste ' + Math.floor(Math.random() * 1000)
            };
            socket.emit('usuario-entrou', dadosUsuario);
            addEvent(`👤 Usuário entrou: ${dadosUsuario.nome}`);
        }

        function simularNovoReporte() {
            // Esta simulação apenas testa recebimento
            // O servidor emite quando um reporte real é criado
            addEvent('🎯 (Servidor emitirá quando reporte real for criado)');
        }

        function simularConquista() {
            // Simular conquista sendo desbloqueada
            addEvent('🏆 (Servidor emitirá quando conquista for desbloqueada)');
        }

        function entrarSalaRanking() {
            socket.emit('entrar-sala-ranking');
            addEvent('📊 Entrou na sala de ranking');
        }

        function entrarSalaAdmin() {
            socket.emit('entrar-sala-admin');
            addEvent('🛡️ Entrou na sala admin');
        }

        function ouvirArea() {
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const dadosArea = { lat: parseFloat(lat), lng: parseFloat(lng), raio: 1 };
            socket.emit('ouvir-area', dadosArea);
            addEvent(`🗺️ Ouvindo área: ${lat}, ${lng}`);
        }

        // Funções auxiliares
        function updateStatus(mensagem, tipo) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = mensagem;
            statusDiv.className = 'status ' + tipo;
        }

        function addEvent(mensagem) {
            const eventLog = document.getElementById('event-log');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            eventDiv.textContent = new Date().toLocaleTimeString() + ' - ' + mensagem;
            eventLog.appendChild(eventDiv);
            eventLog.scrollTop = eventLog.scrollHeight;
        }

        function addNotification(titulo, mensagem, tipo) {
            const notificationsDiv = document.getElementById('notifications');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification';
            notificationDiv.innerHTML = `<strong>${titulo}</strong><br>${mensagem}`;
            
            if (tipo === 'warning') notificationDiv.style.borderLeftColor = '#ffc107';
            if (tipo === 'success') notificationDiv.style.borderLeftColor = '#28a745';
            if (tipo === 'info') notificationDiv.style.borderLeftColor = '#17a2b8';
            
            notificationsDiv.appendChild(notificationDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.parentNode.removeChild(notificationDiv);
                }
            }, 10000);
        }
    </script>
</body>
</html>
